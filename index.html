<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kis Herceg ‚Äì Rendel√©s keres≈ë</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 680px; margin: 0 auto; padding: 18px; }
    input { width: 100%; padding: 12px; font-size: 16px; box-sizing: border-box; }
    button { margin-top: 10px; padding: 12px; width: 100%; font-size: 16px; cursor: pointer; }
    .box { margin-top: 14px; padding: 12px; border: 1px solid #ddd; border-radius: 10px; }
    .muted { opacity: .75; font-size: 12px; margin-top: 8px; }
    ul { margin: 6px 0 10px 20px; }
    .sec { font-weight: bold; margin: 10px 0 6px; }
    code { background:#f3f3f3; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <h2>üìö Kis Herceg ‚Äì N√©v szerinti keres≈ë √∫j</h2>
  <p>√çrd be a neved, √©s kilist√°zzuk a t√©teleidet.</p>

  <input id="name" placeholder="Pl. K√°d√°r Krisztina" />
  <button id="btn" type="button">Keres√©s</button>

  <div id="ver" class="muted"></div>
  <div id="result" class="box">üîé Keres√©shez √≠rd be a neved.</div>

<script>
(() => {
  const VERSION = "VERZI√ì: 2025-12-14  (STABIL-2FORMAT)";

  const $ = (id) => document.getElementById(id);

  function norm(s) {
    return (s || "")
      .toString()
      .trim()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")   // √©kezet le
      .replace(/[‚Äú‚Äù‚Äû"]/g, "")           // id√©z≈ëk le
      .replace(/\s+/g, " ");
  }

  function isATitleLine(line) {
    // A-form√°tum c√≠m: van "lej" √©s van k√∂t≈ëjel/gondolatjel
    const s = line || "";
    if (!s) return false;
    if (/^"?\s*N√âV\s*:/i.test(s)) return false;
    if (/^[‚Ä¢\*\-]/.test(s.trim())) return false;
    if (/^\d+\./.test(s.trim())) return false;
    return /lej/i.test(s) && /[-‚Äì‚Äî]/.test(s);
  }

  function parseAName(line) {
    const m = (line || "").trim().match(/^\d+\.\s*(.+)$/);
    return m ? m[1].trim() : null;
  }

  function parseBHeader(line) {
    // N√âV: ... (id√©z≈ëjellel is)
    const m = (line || "").trim().match(/^"??\s*N√âV\s*:\s*(.+?)\s*"?$/i);
    return m ? m[1].trim() : null;
  }

  async function loadTxt() {
    // cache-biztos
    const url = "rendeles.txt?v=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });
    return { res, text: await res.text() };
  }

  async function search() {
    const qRaw = $("name").value || "";
    const q = norm(qRaw);
    const out = $("result");

    // ‚úÖ EZ BIZTOSAN L√ÅTSZIK: ha ide eljut, a gomb √©s JS m≈±k√∂dik
    out.innerHTML = "‚è≥ Keres√©s indul‚Ä¶ (ha ezt l√°tod, a gomb m√°r biztosan j√≥)";

    if (!q.trim()) {
      out.innerHTML = "üîé √çrj be egy nevet üôÇ";
      return;
    }

    let res, text;
    try {
      const loaded = await loadTxt();
      res = loaded.res;
      text = loaded.text;
    } catch (e) {
      out.innerHTML = "‚ùå Hiba: nem tudtam bet√∂lteni a <code>rendeles.txt</code>-t.";
      return;
    }

    if (!res.ok) {
      out.innerHTML = ‚ùå <code>rendeles.txt</code> HTTP hiba: <b>${res.status}</b>;
      return;
    }

    const lines = text.split(/\r?\n/).map(l => (l || "").trim()).filter(Boolean);

    // A) Aj√°nl√≥s list√°k
    const titles = new Set();
    let currentTitle = "";

    for (const line of lines) {
      if (isATitleLine(line)) { currentTitle = line; continue; }
      const nm = parseAName(line);
      if (nm && currentTitle && norm(nm).includes(q)) titles.add(currentTitle);
    }

    // B) N√âV: blokkok + ‚Ä¢ sorok
    const blocks = new Map(); // displayName -> items[]
    let curName = null;
    let curItems = [];

    const flush = () => {
      if (!curName) return;
      if (!norm(curName).includes(q)) return;
      const prev = blocks.get(curName) || [];
      for (const it of curItems) if (!prev.includes(it)) prev.push(it);
      blocks.set(curName, prev);
    };

    for (const line of lines) {
      const h = parseBHeader(line);
      if (h) {
        flush();
        curName = h;
        curItems = [];
        continue;
      }
      if (curName) {
        if (/^[‚Ä¢\\-]\s/.test(line)) {
          curItems.push(line.replace(/^[‚Ä¢\\-]\s/, "‚Ä¢ ").trim().replace(/^‚Ä¢\s*/, ""));
        } else if (isATitleLine(line)) {
          // ha A-c√≠m j√∂n k√∂zben, lez√°rjuk a blokkot
          flush();
          curName = null;
          curItems = [];
        }
      }
    }
    flush();

    // Eredm√©ny
    if (titles.size === 0 && blocks.size === 0) {
      out.innerHTML = ‚ùå Nincs tal√°lat erre: <b>${qRaw}</b><br><span class="muted">TXT OK (HTTP 200), de nem tal√°lta a nevet.</span>;
      return;
    }

    let html = ‚úÖ <b>Tal√°lat:</b> <b>${qRaw}</b><br><span class="muted">TXT bet√∂ltve: ${text.length} karakter</span><br><br>;

    if (titles.size) {
      html += <div class="sec">üìö Aj√°nl√≥s list√°k:</div><ul>;
      for (const t of titles) html += <li>${t}</li>;
      html += </ul>;
    }

    if (blocks.size) {
      html += <div class="sec">üßæ Rendel√©sek (N√âV: blokk):</div>;
      for (const [name, items] of blocks.entries()) {
        html += <b>${name}</b>;
        if (items.length) {
          html += <ul>;
          for (const it of items) html += <li>${it}</li>;
          html += </ul>;
        } else {
          html += <div class="muted">Nincs ‚Ä¢ t√©telsor ehhez a n√©vhez.</div>;
        }
      }
    }

    out.innerHTML = html;
  }

  // biztos k√∂t√©s
  document.addEventListener("DOMContentLoaded", () => {
    $("ver").innerText = VERSION;
    $("btn").addEventListener("click", search);
    $("name").addEventListener("keydown", (e) => { if (e.key === "Enter") search(); });
  });
})();
</script>
</body>
</html>
